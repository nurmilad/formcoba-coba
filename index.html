<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Pendaftaran Siswa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .form-section, .data-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .form-section {
            flex: 1;
            min-width: 300px;
        }
        
        .data-section {
            flex: 2;
            min-width: 300px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-indicator {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .no-data {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .success-alert {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .error-alert {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .form-section, .data-section {
                width: 100%;
            }
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="form-section">
            <h1>üìù Form Pendaftaran Siswa</h1>
            <p class="subtitle">Data langsung tersimpan online di Firebase Database</p>
            
            <div id="status" class="status-indicator offline">
                üîå Menghubungkan ke database...
            </div>
            
            <div id="successAlert" class="success-alert">
                ‚úÖ Data berhasil disimpan!
            </div>
            
            <div id="errorAlert" class="error-alert">
                ‚ùå Error: <span id="errorMessage"></span>
            </div>
            
            <form id="studentForm">
                <div class="form-group">
                    <label for="nama">Nama Lengkap *</label>
                    <input type="text" id="nama" placeholder="Nama lengkap siswa" required>
                </div>
                
                <div class="form-group">
                    <label for="noHP">Nomor HP/WhatsApp *</label>
                    <input type="tel" id="noHP" placeholder="08123456789" required>
                </div>
                
                <div class="form-group">
                    <label for="alamat">Alamat Lengkap *</label>
                    <textarea id="alamat" placeholder="Alamat lengkap siswa" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="sekolah">Asal Sekolah</label>
                    <input type="text" id="sekolah" placeholder="SMP/SMA asal">
                </div>
                
                <div class="form-group">
                    <label for="jurusan">Jurusan yang Diminati</label>
                    <select id="jurusan">
                        <option value="">Pilih Jurusan</option>
                        <option value="IPA">IPA</option>
                        <option value="IPS">IPS</option>
                        <option value="Bahasa">Bahasa</option>
                        <option value="TKJ">TKJ</option>
                        <option value="Multimedia">Multimedia</option>
                        <option value="Akuntansi">Akuntansi</option>
                    </select>
                </div>
                
                <button type="submit" class="btn" id="submitBtn">
                    <span id="btnText">Simpan ke Database Online</span>
                    <div id="btnSpinner" class="spinner" style="display: none;"></div>
                </button>
            </form>
            
            <div style="margin-top: 20px; text-align: center; font-size: 12px; color: #888;">
                <p>üîí Data aman tersimpan di Firebase (Google)</p>
                <p>üåê Dapat diakses admin dari mana saja</p>
            </div>
        </div>
        
        <div class="data-section">
            <h1>üìä Data Siswa Terdaftar</h1>
            <p class="subtitle">Data real-time dari Firebase Database</p>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalSiswa">0</div>
                    <div class="stat-label">Total Siswa</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="todayCount">0</div>
                    <div class="stat-label">Hari Ini</div>
                </div>
                <div class="stat-item">
                    <button onclick="exportData()" class="btn" style="padding: 8px 15px; font-size: 14px;">
                        üì• Export Data
                    </button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Nama</th>
                            <th>No. HP</th>
                            <th>Jurusan</th>
                            <th>Tanggal</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="5" class="no-data">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h3 style="margin-bottom: 10px; color: #333;">üë®‚Äçüíº Akses untuk Admin:</h3>
                <p style="font-size: 14px; color: #666;">
                    1. Login ke <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a><br>
                    2. Pilih project "FormSiswaDB"<br>
                    3. Klik "Realtime Database"<br>
                    4. Semua data bisa dilihat dan di-download
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==================== KONFIGURASI FIREBASE ====================
        // GANTI dengan konfigurasi Firebase ANDA SENDIRI dari Langkah 3
        const firebaseConfig = {
            apiKey: "AIzaSyDxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
            authDomain: "formsiswadb.firebaseapp.com",
            databaseURL: "https://formsiswadb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "formsiswadb",
            storageBucket: "formsiswadb.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456"
        };
        // ===============================================================
        
        // Inisialisasi Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("‚úÖ Firebase berhasil diinisialisasi");
        } catch (error) {
            console.error("‚ùå Error inisialisasi Firebase:", error);
        }
        
        // Dapatkan referensi database
        const database = firebase.database();
        const siswaRef = database.ref('siswa');
        
        // Elemen DOM
        const form = document.getElementById('studentForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        const statusDiv = document.getElementById('status');
        const successAlert = document.getElementById('successAlert');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        const tableBody = document.getElementById('tableBody');
        const totalSiswa = document.getElementById('totalSiswa');
        const todayCount = document.getElementById('todayCount');
        
        // Cek koneksi Firebase
        function checkConnection() {
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    statusDiv.textContent = "‚úÖ Terhubung ke Database Online";
                    statusDiv.className = "status-indicator online";
                    console.log("üåê Terhubung ke Firebase");
                } else {
                    statusDiv.textContent = "üîå Offline - Periksa koneksi internet";
                    statusDiv.className = "status-indicator offline";
                }
            });
        }
        
        // Format tanggal
        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Simpan data ke Firebase
        async function saveDataToFirebase(data) {
            try {
                // Tampilkan loading
                submitBtn.disabled = true;
                btnText.textContent = "Menyimpan...";
                btnSpinner.style.display = "block";
                
                // Buat ID unik
                const newSiswaRef = siswaRef.push();
                
                // Data lengkap dengan timestamp
                const siswaData = {
                    ...data,
                    id: newSiswaRef.key,
                    tanggal: new Date().toISOString(),
                    tanggalDibaca: formatDate(new Date())
                };
                
                // Simpan ke Firebase
                await newSiswaRef.set(siswaData);
                
                console.log("‚úÖ Data tersimpan:", siswaData);
                
                // Tampilkan pesan sukses
                successAlert.style.display = "block";
                successAlert.textContent = `‚úÖ Data ${data.nama} berhasil disimpan!`;
                
                // Auto hide pesan
                setTimeout(() => {
                    successAlert.style.display = "none";
                }, 3000);
                
                return true;
                
            } catch (error) {
                console.error("‚ùå Error menyimpan data:", error);
                errorMessage.textContent = error.message;
                errorAlert.style.display = "block";
                return false;
                
            } finally {
                // Reset button
                submitBtn.disabled = false;
                btnText.textContent = "Simpan ke Database Online";
                btnSpinner.style.display = "none";
            }
        }
        
        // Muat data dari Firebase
        function loadDataFromFirebase() {
            siswaRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const siswaArray = [];
                let today = 0;
                
                // Reset table
                tableBody.innerHTML = "";
                
                if (data) {
                    // Konversi object ke array
                    Object.keys(data).forEach((key) => {
                        const siswa = data[key];
                        siswaArray.push({
                            id: key,
                            ...siswa
                        });
                        
                        // Hitung data hari ini
                        const todayDate = new Date().toDateString();
                        const siswaDate = new Date(siswa.tanggal).toDateString();
                        if (todayDate === siswaDate) {
                            today++;
                        }
                    });
                    
                    // Urutkan berdasarkan tanggal (terbaru dulu)
                    siswaArray.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
                    
                    // Update stats
                    totalSiswa.textContent = siswaArray.length;
                    todayCount.textContent = today;
                    
                    // Tampilkan di table
                    siswaArray.forEach((siswa, index) => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>
                                <strong>${siswa.nama}</strong><br>
                                <small style="color: #666;">${siswa.sekolah || '-'}</small>
                            </td>
                            <td>${siswa.noHP}</td>
                            <td>
                                <span style="
                                    background: ${siswa.jurusan ? '#e3f2fd' : '#f5f5f5'};
                                    color: ${siswa.jurusan ? '#1976d2' : '#666'};
                                    padding: 3px 8px;
                                    border-radius: 12px;
                                    font-size: 12px;
                                ">
                                    ${siswa.jurusan || 'Belum memilih'}
                                </span>
                            </td>
                            <td>
                                <small>${siswa.tanggalDibaca || formatDate(siswa.tanggal)}</small>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                } else {
                    // Jika tidak ada data
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="no-data">
                                üì≠ Belum ada data siswa yang terdaftar
                            </td>
                        </tr>
                    `;
                    totalSiswa.textContent = "0";
                    todayCount.textContent = "0";
                }
            });
        }
        
        // Export data ke JSON
        function exportData() {
            siswaRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    alert("Belum ada data untuk diexport!");
                    return;
                }
                
                // Konversi ke array
                const dataArray = [];
                Object.keys(data).forEach((key) => {
                    dataArray.push(data[key]);
                });
                
                // Buat file JSON
                const dataStr = JSON.stringify(dataArray, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                // Buat link download
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', `data-siswa-${new Date().toISOString().split('T')[0]}.json`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert("‚úÖ Data berhasil diexport!");
            });
        }
        
        // Event listener untuk form
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Ambil data dari form
            const formData = {
                nama: document.getElementById('nama').value.trim(),
                noHP: document.getElementById('noHP').value.trim(),
                alamat: document.getElementById('alamat').value.trim(),
                sekolah: document.getElementById('sekolah').value.trim(),
                jurusan: document.getElementById('jurusan').value
            };
            
            // Validasi
            if (!formData.nama || !formData.noHP || !formData.alamat) {
                errorMessage.textContent = "Nama, No. HP, dan Alamat wajib diisi!";
                errorAlert.style.display = "block";
                return;
            }
            
            // Validasi nomor HP
            if (!/^[0-9]{10,13}$/.test(formData.noHP)) {
                errorMessage.textContent = "Nomor HP harus 10-13 digit angka!";
                errorAlert.style.display = "block";
                return;
            }
            
            // Sembunyikan error sebelumnya
            errorAlert.style.display = "none";
            
            // Simpan ke Firebase
            const saved = await saveDataToFirebase(formData);
            
            if (saved) {
                // Reset form
                form.reset();
            }
        });
        
        // Validasi input nomor HP
        document.getElementById('noHP').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });
        
        // Inisialisasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            console.log("üöÄ Aplikasi Form Siswa dimulai");
            
            // Cek koneksi
            checkConnection();
            
            // Muat data
            loadDataFromFirebase();
            
            // Log untuk debugging
            console.log("Firebase Config:", firebaseConfig);
            console.log("Database URL:", firebaseConfig.databaseURL);
        });
    </script>
</body>
</html>
